<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Creador de Tiendas ‚Äì Mates Guay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="stylecreador.css">

</head>

<body>
  <div class="wrap">
    <h1>‚ö° Creador Instant√°neo de Tiendas Gualeguay </h1>
    <div class="form-group">
      <label>Seleccion√° tu plan</label>
      <select id="plan" required>
        <option value="Basico">B√°sico</option>
        <option value="Profesional">Profesional</option>
        <option value="Premium">Premium</option>
      </select>
    </div>

    <!-- üí° Mensaje din√°mico del plan -->
    <p id="infoPlan" style="color:#0b5ed7; font-weight:bold; margin-top:-5px; margin-bottom:10px;">
      üîπ Seleccion√° un plan para ver sus l√≠mites de productos.
    </p>


    <div class="form-group">
      <label>Tipo de tienda</label>
      <select id="rubro" required>
        <option value="">-- Seleccionar rubro --</option>
        <option value="carniceria">Carnicer√≠a</option>
        <option value="verduleria">Verduler√≠a</option>
        <option value="polleria">Poller√≠a</option>
        <option value="kiosko">Kiosko</option>
        <option value="ropa">Tienda de Ropa</option>
        <option value="mates">Mates y artesan√≠as</option>
      </select>
    </div>


    <div class="card">
      <div class="row">
        <div>
          <label>Tienda ID (sin espacios)</label>
          <input id="tiendaId" placeholder="MATES-GUAY-LOCAL-12" />
        </div>
        <div>
          <label>Nombre p√∫blico</label>
          <input id="nombre" placeholder="Mates Guay ‚Äì Local 12" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>WhatsApp (solo n√∫meros, con pa√≠s)</label>
          <input id="whatsapp" placeholder="5492644429649" />
        </div>
        <div>
          <label>Imagen para redes (OpenGraph/Twitter) ‚Äì opcional</label>
          <input id="metaImage" placeholder="https://.../600x315.png" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Direcci√≥n</label>
          <input id="direccion" placeholder="Calle y n√∫mero, Ciudad (Prov.)" />
        </div>
        <div>
          <label>Horarios</label>
          <input id="horarios" placeholder="Lunes a S√°bado 9 a 13 y 17 a 20 hs" />
        </div>
      </div>

      <!-- Logo -->
      <label>Logo de la tienda</label>
      <input id="logoUrl" placeholder="https://.../logo.png (opcional)">
      <p style="font-size:0.85em; opacity:0.8;">O sub√≠ una imagen desde tu dispositivo:</p>
      <input type="file" id="logoFile" accept="image/*">
      <img id="preview-logo-upload" src="" alt="Vista previa del logo"
        style="max-height:80px; margin-top:10px; display:none; border-radius:8px;">

      <!-- üé® Paleta de colores -->
      <h3 style="margin-top:20px;">üé® Personalizaci√≥n de colores</h3>
      <div class="row">
        <div>
          <label>Color de fondo del Header</label>
          <input id="colorHeader" type="color" value="#007bff" />
        </div>
        <div>
          <label>Color de texto del Header</label>
          <input id="colorHeaderText" type="color" value="#ffffff" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Color de fondo del Footer</label>
          <input id="colorFooter" type="color" value="#003366" />
        </div>
        <div>
          <label>Color de texto del Footer</label>
          <input id="colorFooterText" type="color" value="#ffffff" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Color del bot√≥n del carrito</label>
          <input id="colorBoton" type="color" value="#20f1f5" />
        </div>
      </div>

      <button id="crear">Crear tienda</button>
      <div id="msg" class="ok"></div>
    </div>

    <!-- üëÄ Vista previa -->
    <div class="card" style="margin-top:25px;">
      <h3>üëÄ Vista previa en vivo</h3>
      <div id="preview" style="border:1px solid #333; border-radius:10px; overflow:hidden;">
        <header id="preview-header" style="background:#007bff; color:white; padding:15px; text-align:center;">
          <img id="preview-logo" src="" alt="" style="max-height:60px; vertical-align:middle; margin-right:10px;">
          <span id="preview-nombre" style="font-size:1.5em; font-weight:700;">Tu tienda</span>
        </header>
        <main style="padding:20px; background:#f7f7f7; color:#222;">
          <p>üßâ As√≠ se ver√° tu tienda digital.</p>
          <div id="preview-info" style="margin-top:20px; font-size:0.95em;">
            <!-- üõçÔ∏è Vista previa de productos -->
            <div id="preview-productos"
              style="margin-top:25px; display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px;">
            </div>

            <p><strong>üìç Direcci√≥n:</strong> <span id="preview-direccion">Sin direcci√≥n</span></p>
            <p><strong>üïí Horario:</strong> <span id="preview-horario">Sin horario</span></p>
            <p><strong>üì± WhatsApp:</strong> <span id="preview-whatsapp">---</span></p>
          </div>
        </main>
        <footer id="preview-footer" style="background:#003366; color:white; text-align:center; padding:10px;">
          <small>¬© 2025 Tu Tienda</small>
        </footer>
      </div>
    </div>



    <div class="card">
      <h3>Links r√°pidos</h3>
      <p class="small">Se mostrar√°n cuando la tienda est√© creada:</p>
      <div class="grid">
        <div>üîó Tienda p√∫blica: <a id="linkPublico" class="link" target="_blank"></a></div>
        <div>üõ†Ô∏è Panel admin: <a id="linkAdmin" class="link" target="_blank"></a></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
    import { getFirestore, doc, setDoc, collection, addDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA36uwBk0FBDc6rI16BAsqUNe_AXLpv62Q",
      authDomain: "carniceriadonjose-48638.firebaseapp.com",
      projectId: "carniceriadonjose-48638",
      storageBucket: "carniceriadonjose-48638.appspot.com",
      messagingSenderId: "322531750471",
      appId: "1:322531750471:web:78e290c9c81eecc7be3762"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const el = id => document.getElementById(id);

    // Mostrar info del plan seleccionado
    el("plan").addEventListener("change", () => {
      const plan = el("plan").value;
      if (plan === "Basico") el("infoPlan").textContent = "üîπ El plan B√°sico cargar√° solo 40 productos.";
      if (plan === "Profesional") el("infoPlan").textContent = "üíº El plan Profesional cargar√° hasta 100 productos.";
      if (plan === "Premium") el("infoPlan").textContent = "üöÄ El plan Premium cargar√° todos los productos disponibles.";
    });


    // üì¶ CREAR TIENDA
    async function crearTienda() {
      const tiendaId = (el("tiendaId").value || "").trim();
      const nombre = (el("nombre").value || "").trim();
      const whatsapp = (el("whatsapp").value || "").trim();

      // üì∏ L√≥gica combinada de logo
      let logoUrlFinal = "";
      const file = el("logoFile").files[0];
      const linkManual = el("logoUrl").value.trim();

      if (file) {
        const storageRef = ref(storage, `logos/${tiendaId}/${file.name}`);
        await uploadBytes(storageRef, file);
        logoUrlFinal = await getDownloadURL(storageRef);
      } else if (linkManual) {
        logoUrlFinal = linkManual;
      } else {
        // üîπ Logo sugerido seg√∫n rubro (con URLs absolutas)
        const rubroSeleccionado = el("rubro").value;
        const logosSugeridos = {
          carniceria: "https://josema1031.github.io/multitiendas/logos/carniceria.png",
          verduleria: "https://josema1031.github.io/multitiendas/logos/verduleria.png",
          polleria: "https://josema1031.github.io/multitiendas/logos/polleria.png",
          kiosko: "https://josema1031.github.io/multitiendas/logos/kiosko.png",
          ropa: "https://josema1031.github.io/multitiendas/logos/ropa.png",
          mates: "https://josema1031.github.io/multitiendas/logos/mates.png"
        };
        logoUrlFinal = logosSugeridos[rubroSeleccionado] || "https://placehold.co/300x300?text=Sin+Logo";
      }

      const direccion = (el("direccion").value || "").trim();
      const horarios = (el("horarios").value || "").trim();
      const metaImage = (el("metaImage").value || "").trim();
      const colorHeader = el("colorHeader").value;
      const colorFooter = el("colorFooter").value;
      const colorHeaderText = el("colorHeaderText").value;
      const colorFooterText = el("colorFooterText").value;
      const colorBoton = el("colorBoton").value;
      const plan = el("plan").value;
      const rubro = el("rubro").value;

      if (!tiendaId || !nombre || !whatsapp) {
        el("msg").innerHTML = "‚ùå Complet√° Tienda ID, Nombre y WhatsApp.";
        return;
      }

      // ‚úÖ Evitar guardar valor vac√≠o en Firestore
      if (!logoUrlFinal || logoUrlFinal.trim() === "") {
        logoUrlFinal = "https://placehold.co/300x300?text=Sin+Logo";
      }

      const configRef = doc(db, "tiendas", tiendaId, "config", "datos");
      const configSnap = await getDoc(configRef);

      if (configSnap.exists()) {
        const confirmar = confirm(`‚ö†Ô∏è La tienda "${tiendaId}" ya existe.\n¬øQuer√©s actualizar su plan y configuraci√≥n?`);
        if (!confirmar) return;

        await updateDoc(configRef, {
          plan,
          nombre,
          whatsapp,
          direccion,
          horarios,
          colorHeader,
          colorFooter,
          colorHeaderText,
          colorFooterText,
          colorBoton,
          logo: logoUrlFinal,
          rubro
        });

        alert("‚úÖ Tienda actualizada correctamente");
        return;
      }

      // üîπ Guardar configuraci√≥n inicial
      await setDoc(doc(db, "tiendas", tiendaId, "config", "datos"), {
        nombre,
        whatsapp,
        direccion,
        horarios,
        logo: logoUrlFinal,
        colorHeader,
        colorFooter,
        colorHeaderText,
        colorFooterText,
        colorBoton,
        plan,
        rubro
      });

      // ‚úÖ Documento ra√≠z
      await setDoc(doc(db, "tiendas", tiendaId), { creado: new Date().toISOString() });


      // üßâ Cargar productos iniciales seg√∫n el rubro
      const productosRef = collection(db, "tiendas", tiendaId, "productos");

      if (rubro) {
        try {
          const response = await fetch(`plantillas/${rubro}.json`);
          let productosBase = await response.json();

          // üü¶ Obtener el plan y aplicar l√≠mite
          let limite = 0;
          if (plan === "Basico") limite = 40;
          else if (plan === "Profesional") limite = 100;
          else if (plan === "Premium") limite = Infinity;

          // ‚úÇÔ∏è Recortar productos seg√∫n el l√≠mite del plan
          if (limite !== Infinity && productosBase.length > limite) {
            productosBase = productosBase.slice(0, limite);
            console.warn(`‚ö†Ô∏è Plan ${plan}: solo se cargar√°n ${limite} productos de ${productosBase.length} disponibles.`);
          }

          // üîÑ Subir productos limitados a Firestore
          for (const p of productosBase) {
            await addDoc(productosRef, p);
          }

          console.log(`‚úÖ Cargados ${productosBase.length} productos (${plan}) para ${rubro}`);
        } catch (error) {
          console.warn("‚ö†Ô∏è No se pudieron cargar los productos predeterminados:", error);
        }
      } else {
        // Si no se seleccion√≥ rubro, cargar productos demo gen√©ricos
        const demo = [
          { nombre: "Mate Imperial", precio: 18000, categoria: "Imperial", imagen: logoUrlFinal, stock: 10, orden: 0 },
          { nombre: "Bombilla de acero", precio: 5000, categoria: "Oferta", imagen: "https://placehold.co/300x300?text=Producto", stock: 20, orden: 1 },
          { nombre: "Combo mate + bombilla", precio: 21000, categoria: "Combo", imagen: "https://placehold.co/300x300?text=Producto", stock: 5, orden: 2 }
        ];
        for (const p of demo) await addDoc(productosRef, p);
        console.log("üß© Cargados productos demo por defecto (sin rubro)");
      }



      // üåê Generar enlaces
      const base = window.location.origin + window.location.pathname.replace("creador.html", "");
      const linkPublico = `${base}index.html?tienda=${encodeURIComponent(tiendaId)}`;
      const linkAdmin = `${base}admin.html?tienda=${encodeURIComponent(tiendaId)}`;

      el("linkPublico").href = linkPublico;
      el("linkPublico").textContent = linkPublico;
      el("linkAdmin").href = linkAdmin;
      el("linkAdmin").textContent = linkAdmin;



      el("msg").innerHTML = "‚úÖ ¬°Tienda creada! Ya pod√©s abrir los links.";
    }



    el("crear").addEventListener("click", crearTienda);

    // üé® VISTA PREVIA DE PRODUCTOS POR RUBRO
    function mostrarProductosPreview() {
      const rubro = el("rubro").value;
      const contenedor = el("preview-productos");
      contenedor.innerHTML = "";

      const ejemplos = {
        carniceria: [
          { nombre: "Asado de tira", imagen: "https://github.com/Josema1031/tiendasguay/blob/main/imag/asado%20de%20tira.jpg?raw=true" },
          { nombre: "Chorizo parrillero", imagen: "https://cdn.pixabay.com/photo/2018/05/12/22/36/sausages-3398567_1280.jpg" }
        ],
        verduleria: [
          { nombre: "Tomate", imagen: "https://cdn.pixabay.com/photo/2016/03/05/22/24/tomatoes-1239181_1280.jpg" },
          { nombre: "Lechuga", imagen: "https://cdn.pixabay.com/photo/2018/05/18/17/50/lettuce-3417363_1280.jpg" }
        ],
        polleria: [
          { nombre: "Pechuga de pollo", imagen: "https://cdn.pixabay.com/photo/2016/03/05/22/34/chicken-1239180_1280.jpg" },
          { nombre: "Pollo trozado", imagen: "https://cdn.pixabay.com/photo/2018/04/13/21/42/chicken-3319178_1280.jpg" }
        ],
        kiosko: [
          { nombre: "Gaseosa cola 500ml", imagen: "https://cdn.pixabay.com/photo/2017/01/23/19/40/coca-cola-2002370_1280.jpg" },
          { nombre: "Papas fritas", imagen: "https://cdn.pixabay.com/photo/2016/03/05/20/07/potato-chips-1239140_1280.jpg" }
        ],
        ropa: [
          { nombre: "Remera b√°sica", imagen: "https://cdn.pixabay.com/photo/2016/03/27/21/16/t-shirt-1281840_1280.jpg" },
          { nombre: "Pantal√≥n jean", imagen: "https://cdn.pixabay.com/photo/2016/11/22/22/18/jeans-1853970_1280.jpg" }
        ],
        mates: [
          { nombre: "Mate Imperial", imagen: "https://cdn.pixabay.com/photo/2020/07/06/16/58/mate-5379305_1280.jpg" },
          { nombre: "Bombilla acero", imagen: "https://cdn.pixabay.com/photo/2018/09/04/21/55/bombilla-3656620_1280.jpg" }
        ]
      };

      if (!rubro || !ejemplos[rubro]) return;

      ejemplos[rubro].forEach(p => {
        const card = document.createElement("div");
        card.style.background = "#fff";
        card.style.borderRadius = "10px";
        card.style.padding = "10px";
        card.style.textAlign = "center";
        card.style.boxShadow = "0 3px 8px rgba(0,0,0,0.15)";
        card.innerHTML = `
      <img src="${p.imagen}" alt="${p.nombre}" style="width:100%;height:100px;object-fit:cover;border-radius:8px;">
      <p style="margin-top:8px;font-size:0.9em;color:#111;">${p.nombre}</p>`;
        contenedor.appendChild(card);
      });
    }





    // üîÑ Evento al cambiar rubro
    el("rubro").addEventListener("change", mostrarProductosPreview);

    // ü™Ñ Vista previa en vivo
    function actualizarVistaPrevia() {
      const nombre = el("nombre").value || "Tu tienda";
      const linkLogo = el("logoUrl").value.trim();
      const file = el("logoFile").files[0];

      const colorHeader = el("colorHeader").value;
      const colorHeaderText = el("colorHeaderText").value;
      const colorFooter = el("colorFooter").value;
      const colorFooterText = el("colorFooterText").value;
      const colorBoton = el("colorBoton").value;

      const direccion = el("direccion").value || "Sin direcci√≥n";
      const horarios = el("horarios").value || "Sin horario";
      const whatsapp = el("whatsapp").value || "---";

      // HEADER PROFESIONAL
      // HEADER PROFESIONAL CON LOGO DESTACADO
      const header = document.getElementById("preview-header");
      header.style.display = "flex";
      header.style.alignItems = "center";
      header.style.justifyContent = "center";
      header.style.gap = "18px";
      header.style.padding = "20px";
      header.style.background = colorHeader;
      header.style.color = colorHeaderText;
      header.style.borderBottom = "2px solid rgba(255,255,255,0.25)";
      header.style.flexWrap = "wrap";

      // T√çTULO
      const nombreEl = document.getElementById("preview-nombre");
      nombreEl.textContent = nombre;
      nombreEl.style.color = colorHeaderText;
      nombreEl.style.fontSize = "2.2rem";
      nombreEl.style.fontWeight = "800";
      nombreEl.style.margin = "0";
      nombreEl.style.textShadow = "0 2px 4px rgba(0,0,0,0.3)";

      // LOGO GRANDE
      const logoEl = document.getElementById("preview-logo");
      logoEl.style.height = "90px"; // üí™ tama√±o fijo m√°s grande
      logoEl.style.width = "auto";
      logoEl.style.maxHeight = "none"; // elimina limitaci√≥n previa
      logoEl.style.objectFit = "contain";
      logoEl.style.borderRadius = "10px";
      logoEl.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)";
      logoEl.style.transition = "transform 0.25s ease, filter 0.25s ease";
      logoEl.style.filter = "drop-shadow(0 3px 6px rgba(0,0,0,0.25))";

      logoEl.onmouseover = () => (logoEl.style.transform = "scale(1.08)");
      logoEl.onmouseout = () => (logoEl.style.transform = "scale(1)");

      // Mostrar el logo seg√∫n archivo o link
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          logoEl.src = e.target.result;
          logoEl.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else if (linkLogo) {
        logoEl.src = linkLogo;
        logoEl.style.display = "block";
      } else {
        logoEl.style.display = "none";
      }


      // INFO
      document.getElementById("preview-direccion").textContent = direccion;
      document.getElementById("preview-horario").textContent = horarios;
      document.getElementById("preview-whatsapp").textContent = whatsapp;

      // FOOTER
      const footer = document.getElementById("preview-footer");
      footer.style.background = colorFooter;
      footer.style.color = colorFooterText;
      footer.innerHTML = `<small>¬© 2025 ${nombre}</small>`;

      // BOT√ìN DE CARRITO SIMB√ìLICO
      let boton = document.getElementById("preview-boton");
      if (!boton) {
        boton = document.createElement("button");
        boton.id = "preview-boton";
        boton.textContent = "üõí Ver carrito";
        boton.style.marginTop = "15px";
        document.getElementById("preview-info").appendChild(boton);
      }
      boton.style.background = colorBoton;
      boton.style.border = "none";
      boton.style.color = "#000";
      boton.style.padding = "10px 20px";
      boton.style.borderRadius = "8px";
      boton.style.fontWeight = "600";
    }

    ["nombre", "logoUrl", "logoFile", "colorHeader", "colorHeaderText", "colorFooter", "colorFooterText", "colorBoton", "direccion", "horarios", "whatsapp", "rubro"].forEach(id => {
      const input = el(id);
      if (input) {
        input.addEventListener("input", () => {
          actualizarVistaPrevia();
          if (id === "rubro") mostrarProductosPreview(); // üîÑ cuando cambie rubro, mostrar productos
        });
        if (input.type === "file") input.addEventListener("change", actualizarVistaPrevia);
      }
    });


    actualizarVistaPrevia();
    mostrarProductosPreview();


  </script>
</body>

</html>